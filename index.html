<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PBR Studio - 3D Material Viewer</title>
    <!-- Favicon (Cube Emoji) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§Š</text></svg>">
    
    <style>
        /* --- Reset & Layout --- */
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #0f0f0f; color: #eee; }
        canvas { display: block; outline: none; width: 100vw; height: 100vh; }
        
        /* --- Loading Screen --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #4ecca3; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* --- UI Panel (Right Side) --- */
        #control-panel {
            position: absolute; top: 0; right: 0;
            width: 320px; height: 100vh;
            background: rgba(25, 25, 25, 0.95);
            border-left: 1px solid #333;
            overflow-y: auto;
            box-shadow: -5px 0 20px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; z-index: 100;
            backdrop-filter: blur(10px);
        }

        .panel-content { padding: 20px; padding-bottom: 100px; }

        /* Typography */
        h2 { margin: 0 0 15px 0; font-size: 18px; color: #4ecca3; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid #4ecca3; padding-bottom: 10px; text-align: center; }
        h3 { font-size: 12px; margin-top: 20px; margin-bottom: 10px; color: #fff; background: #333; padding: 8px; border-radius: 4px; border-left: 3px solid #4ecca3; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Controls */
        .control-group { margin-bottom: 12px; }
        .control-group label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: #bbb; font-weight: 500; }
        
        .input-row { display: flex; align-items: center; gap: 10px; }
        input[type=range] { flex-grow: 1; cursor: pointer; accent-color: #4ecca3; height: 4px; background: #444; border-radius: 2px; }
        input[type=number] { width: 45px; background: #222; border: 1px solid #444; color: #4ecca3; font-size: 11px; padding: 4px; border-radius: 4px; text-align: right; }
        input[type=number]:focus { outline: none; border-color: #4ecca3; }

        select { width: 100%; background: #222; color: #eee; border: 1px solid #444; padding: 8px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        select:hover { border-color: #666; }

        /* Buttons */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        button { padding: 8px; background: #333; border: 1px solid #444; color: #eee; border-radius: 4px; cursor: pointer; font-size: 11px; transition: all 0.2s; font-weight: 500; }
        button:hover { background: #444; border-color: #666; color: #fff; }
        button.action-btn { background: #007bff; border: none; width: 100%; margin-top: 5px; color: white; padding: 10px; }
        button.action-btn:hover { background: #0069d9; }
        button.reset-btn { background: #d9534f; margin-top: 20px; }
        button.reset-btn:hover { background: #c9302c; }

        .checkbox-row { display: flex; align-items: center; font-size: 12px; color: #ccc; margin-bottom: 10px; cursor: pointer; }
        .checkbox-row input { margin-right: 10px; accent-color: #4ecca3; width: 14px; height: 14px; cursor: pointer; }
        .checkbox-row label { cursor: pointer; }

        /* Texture Slots */
        .texture-slot { margin-bottom: 10px; border: 1px dashed #555; padding: 10px; border-radius: 6px; background: #1a1a1a; position: relative; transition: all 0.2s; }
        .texture-slot:hover { border-color: #888; background: #222; }
        .texture-slot.drag-over { border-color: #4ecca3; background: #252e29; transform: scale(1.02); }
        .texture-slot.loaded { border-style: solid; border-color: #4ecca3; background: #1e2522; }
        
        .texture-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .texture-label { font-size: 11px; font-weight: 700; color: #aaa; }
        .texture-toggle { transform: scale(0.9); cursor: pointer; }
        
        .file-name-display { font-size: 10px; color: #4ecca3; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: none; background: rgba(78, 204, 163, 0.1); padding: 2px 4px; border-radius: 2px; }
        
        input[type=file] { font-size: 10px; width: 100%; margin-top: 2px; }
        input[type=file]::file-selector-button { background: #333; border: none; color: white; padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-right: 8px; transition: 0.2s; }
        input[type=file]::file-selector-button:hover { background: #555; }

        /* Overlay */
        #drop-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 200; pointer-events: none; opacity: 0; transition: opacity 0.2s; backdrop-filter: blur(5px); }
        #drop-overlay.active { opacity: 1; pointer-events: auto; }
        #drop-overlay h1 { color: #4ecca3; border: 4px dashed #4ecca3; padding: 60px; border-radius: 30px; background: rgba(0,0,0,0.6); font-size: 24px; pointer-events: none; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loader">
        <div class="spinner"></div>
        <div style="color: #888; font-size: 12px; letter-spacing: 1px;">MEMUAT STUDIO...</div>
    </div>

    <!-- Drag & Drop Overlay -->
    <div id="drop-overlay">
        <h1>Lepaskan File Disini</h1>
    </div>

    <!-- Control Panel -->
    <div id="control-panel">
        <div class="panel-content">
            <h2>PBR Studio</h2>

            <!-- GEOMETRY & CAMERA -->
            <h3>Scene & Kamera</h3>
            <div class="control-group">
                <select id="geo-select" onchange="changeGeometry(this.value)">
                    <option value="sphere" selected>Bola (Sphere)</option>
                    <option value="cube">Kotak (Rounded Cube)</option>
                    <option value="wall">Dinding (Panel)</option>
                    <option value="corner">Sudut Ruangan</option>
                    <option value="floor">Lantai (Grid)</option>
                </select>
            </div>
            
            <div class="btn-grid">
                <button onclick="setCamera('front')">Depan</button>
                <button onclick="setCamera('angle')">Sudut 45&deg;</button>
                <button onclick="setCamera('top')">Atas</button>
                <button onclick="setCamera('close')">Zoom Dekat</button>
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="auto-rotate" onchange="toggleAutoRotate(this.checked)">
                <label for="auto-rotate">Auto Rotate (Turntable)</label>
            </div>

            <!-- LIGHTING -->
            <h3>Pencahayaan</h3>
            <div class="control-group">
                <label>Intensitas</label>
                <div class="input-row">
                    <input type="range" id="light-intensity" min="0" max="5" step="0.1" value="1.5">
                    <input type="number" id="num-light-intensity" value="1.5">
                </div>
            </div>
            <div class="control-group">
                <label>Kelembutan Bayangan</label>
                <div class="input-row">
                    <input type="range" id="light-soft" min="1" max="10" step="1" value="2">
                    <input type="number" id="num-light-soft" value="2">
                </div>
            </div>
            <div class="control-group">
                <label>Rotasi Cahaya X</label>
                <div class="input-row">
                    <input type="range" id="light-pos-x" min="-50" max="50" step="1" value="10">
                    <input type="number" id="num-light-pos-x" value="10">
                </div>
            </div>
            <div class="control-group">
                <label>Rotasi Cahaya Z</label>
                <div class="input-row">
                    <input type="range" id="light-pos-z" min="-50" max="50" step="1" value="10">
                    <input type="number" id="num-light-pos-z" value="10">
                </div>
            </div>
            <div class="checkbox-row">
                <input type="checkbox" id="env-map" checked onchange="toggleEnvMap(this.checked)">
                <label for="env-map">Refleksi Ruangan (HDRI)</label>
            </div>

            <!-- MATERIAL PROPERTIES -->
            <h3>Properti Material</h3>
            <div class="control-group">
                <label>Metalness (Logam)</label>
                <div class="input-row">
                    <input type="range" id="mat-metal" min="0" max="1" step="0.05" value="0.5">
                    <input type="number" id="num-mat-metal" value="0.5">
                </div>
            </div>
            <div class="control-group">
                <label>Roughness (Kekasaran)</label>
                <div class="input-row">
                    <input type="range" id="mat-rough" min="0" max="1" step="0.05" value="0.5">
                    <input type="number" id="num-mat-rough" value="0.5">
                </div>
            </div>
            <div class="control-group">
                <label style="color: #6cf;">Efek Basah (Wetness)</label>
                <div class="input-row">
                    <input type="range" id="mat-wetness" min="0" max="1" step="0.05" value="0">
                    <input type="number" id="num-mat-wetness" value="0">
                </div>
            </div>

            <!-- MODIFIERS -->
            <h3>Modifikasi Texture</h3>
            <div class="control-group">
                <label>Tiling X (Ulangi Hor.)</label>
                <div class="input-row">
                    <input type="range" id="mat-tiling-x" min="0.1" max="10" step="0.1" value="1.0">
                    <input type="number" id="num-mat-tiling-x" value="1.0">
                </div>
            </div>
            <div class="control-group">
                <label>Tiling Y (Ulangi Vert.)</label>
                <div class="input-row">
                    <input type="range" id="mat-tiling-y" min="0.1" max="10" step="0.1" value="1.0">
                    <input type="number" id="num-mat-tiling-y" value="1.0">
                </div>
            </div>
            <div class="control-group">
                <label>Rotasi Texture</label>
                <div class="input-row">
                    <input type="range" id="mat-rot-tex" min="0" max="360" step="1" value="0">
                    <input type="number" id="num-mat-rot-tex" value="0">
                </div>
            </div>
            
            <div class="control-group">
                <label>Random Seed (Posisi Acak)</label>
                <div class="input-row">
                    <input type="number" id="rand-seed" value="12345" style="width: 100%;">
                    <button style="width: 50px;" onclick="randomizeOffset()">Acak</button>
                </div>
            </div>

            <div class="control-group">
                <label>Displacement Scale</label>
                <div class="input-row">
                    <input type="range" id="mat-disp" min="0" max="2" step="0.05" value="0">
                    <input type="number" id="num-mat-disp" value="0">
                </div>
            </div>
            <div class="control-group">
                <label>Normal Scale</label>
                <div class="input-row">
                    <input type="range" id="mat-norm" min="0" max="5" step="0.1" value="1.0">
                    <input type="number" id="num-mat-norm" value="1.0">
                </div>
            </div>

            <!-- TEXTURE SLOTS -->
            <h3>Upload Textures</h3>
            <div style="font-size: 10px; color: #888; margin-bottom: 10px; font-style: italic;">
                Drag & drop file ke kotak di bawah, atau ke layar utama (otomatis).
            </div>
            
            <div id="texture-slots-container">
                <!-- Diisi oleh Javascript -->
            </div>

            <button class="action-btn reset-btn" onclick="resetMaterial()">Reset Semua</button>
        </div>
    </div>

    <!-- External Libraries (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/RoundedBoxGeometry.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/environments/RoomEnvironment.js"></script>

    <script>
        // --- Variables ---
        let scene, camera, renderer, controls;
        let mainMaterial, activeMesh;
        let dirLight, ambientLight, pmremGenerator;
        let textureOffset = new THREE.Vector2(0, 0);
        let rawRoughness = 0.5, rawMetalness = 0.5;
        let textureCache = {}; 
        
        const mapTypes = [
            { id: 'map', label: 'Albedo / Warna' },
            { id: 'normalMap', label: 'Normal Map' },
            { id: 'roughnessMap', label: 'Roughness Map' },
            { id: 'metalnessMap', label: 'Metalness Map' },
            { id: 'aoMap', label: 'Ambient Occlusion (AO)' },
            { id: 'displacementMap', label: 'Displacement / Height' }
        ];

        // --- Initialization ---
        function init() {
            // Hide Loader
            setTimeout(() => {
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }, 1000);

            // Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f0f0f);
            
            camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 320) / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 30);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth - 320, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            document.body.appendChild(renderer.domElement);

            // Environment
            pmremGenerator = new THREE.PMREMGenerator(renderer);
            pmremGenerator.compileEquirectangularShader();
            scene.environment = pmremGenerator.fromScene(new THREE.RoomEnvironment(), 0.04).texture;

            // Default Material
            mainMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                roughness: 0.5,
                metalness: 0.5,
                normalScale: new THREE.Vector2(1, 1),
                displacementScale: 0,
                envMapIntensity: 1.0,
                side: THREE.DoubleSide // Safer for walls/planes
            });

            // Lighting
            ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
            scene.add(ambientLight);

            dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            dirLight.shadow.bias = -0.0001;
            dirLight.shadow.radius = 2;
            scene.add(dirLight);

            const fillLight = new THREE.DirectionalLight(0x8888ff, 0.4);
            fillLight.position.set(-10, 0, -10);
            scene.add(fillLight);

            // Orbit Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = false;

            // Initialize Geometry & UI
            changeGeometry('sphere');
            createTextureSlots();
            setupEventListeners();
            setupDragAndDrop(); 
            
            // Resize Listener
            window.addEventListener('resize', onWindowResize, false);
            
            animate();
        }

        // --- Geometry Logic ---
        function changeGeometry(type) {
            if (activeMesh) {
                scene.remove(activeMesh);
                activeMesh.geometry.dispose();
            }

            let geo;
            switch(type) {
                case 'sphere':
                    geo = new THREE.SphereGeometry(6, 128, 128);
                    break;
                case 'cube':
                    geo = new THREE.RoundedBoxGeometry(9, 9, 9, 10, 0.5); 
                    break;
                case 'wall':
                    geo = new THREE.PlaneGeometry(16, 12, 128, 128);
                    break;
                case 'floor':
                    geo = new THREE.PlaneGeometry(20, 20, 128, 128);
                    break;
                case 'corner':
                    geo = new THREE.RoundedBoxGeometry(12, 12, 12, 10, 0.2);
                    break;
            }

            activeMesh = new THREE.Mesh(geo, mainMaterial);
            
            if (type === 'floor') {
                activeMesh.rotation.x = -Math.PI / 2;
                activeMesh.position.y = -5;
            } else if (type === 'wall') {
                activeMesh.position.y = 0;
                activeMesh.rotation.set(0,0,0);
            } else {
                activeMesh.position.set(0, 0, 0);
                activeMesh.rotation.set(0,0,0);
            }

            activeMesh.castShadow = true;
            activeMesh.receiveShadow = true;
            scene.add(activeMesh);
        }

        // --- Core Functions ---
        function setCamera(mode) {
            controls.reset();
            switch(mode) {
                case 'front': camera.position.set(0, 0, 30); break;
                case 'angle': camera.position.set(20, 15, 20); break;
                case 'top': camera.position.set(0, 30, 1); break;
                case 'close': camera.position.set(0, 0, 10); break;
            }
        }

        function toggleAutoRotate(val) {
            controls.autoRotate = val;
            controls.autoRotateSpeed = 2.0;
        }

        function updateMaterialResponse() {
            const wet = parseFloat(document.getElementById('mat-wetness').value);
            const targetRough = 0.02;
            
            mainMaterial.roughness = THREE.MathUtils.lerp(rawRoughness, targetRough, wet);
            const darkenFactor = THREE.MathUtils.lerp(1.0, 0.6, wet);
            mainMaterial.color.setHSL(0, 0, darkenFactor);
            
            const normScale = parseFloat(document.getElementById('mat-norm').value);
            const wetNormScale = THREE.MathUtils.lerp(normScale, normScale * 0.5, wet);
            mainMaterial.normalScale.set(wetNormScale, wetNormScale);
            
            mainMaterial.metalness = rawMetalness;
        }

        // --- Randomization ---
        function seededRandom(seed) {
            var x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        window.randomizeOffset = function() {
            const seedVal = parseInt(document.getElementById('rand-seed').value) || 12345;
            const rX = seededRandom(seedVal);
            const rY = seededRandom(seedVal + 1);
            textureOffset.set(rX, rY);
            updateAllTextures();
            document.getElementById('rand-seed').value = seedVal + 1;
        };

        // --- Texture Handling ---
        function createTextureSlots() {
            const container = document.getElementById('texture-slots-container');
            container.innerHTML = '';
            
            mapTypes.forEach(type => {
                const div = document.createElement('div');
                div.className = 'texture-slot';
                div.id = `slot-${type.id}`;
                div.innerHTML = `
                    <div class="texture-header">
                        <span class="texture-label">${type.label}</span>
                        <input type="checkbox" class="texture-toggle" checked onchange="toggleTexture('${type.id}', this.checked)" title="On/Off">
                    </div>
                    <input type="file" onchange="loadTextureFromFile(this.files[0], '${type.id}')" accept="image/*">
                    <div class="file-name-display" id="name-${type.id}"></div>
                `;
                
                // Drop Events
                div.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); div.classList.add('drag-over'); });
                div.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); div.classList.remove('drag-over'); });
                div.addEventListener('drop', (e) => {
                    e.preventDefault(); e.stopPropagation(); div.classList.remove('drag-over');
                    if (e.dataTransfer.files.length > 0) loadTextureFromFile(e.dataTransfer.files[0], type.id);
                });
                
                container.appendChild(div);
            });
        }

        function loadTextureFromFile(file, type) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const image = new Image();
                image.src = e.target.result;
                const texture = new THREE.Texture(image);
                image.onload = () => {
                    texture.needsUpdate = true;
                    textureCache[type] = texture;
                    
                    if (document.querySelector(`#slot-${type} .texture-toggle`).checked) {
                        mainMaterial[type] = texture;
                    }
                    
                    applyTextureSettings(texture);
                    if (type === 'displacementMap' && mainMaterial.displacementScale === 0) {
                        mainMaterial.displacementScale = 0.5;
                        syncInputs('mat-disp', 0.5);
                    }
                    mainMaterial.needsUpdate = true;
                    
                    const slot = document.getElementById(`slot-${type}`);
                    slot.classList.add('loaded');
                    const name = document.getElementById(`name-${type}`);
                    name.style.display = 'block';
                    name.innerText = file.name;
                };
            };
            reader.readAsDataURL(file);
        }

        function toggleTexture(type, isVisible) {
            mainMaterial[type] = (isVisible && textureCache[type]) ? textureCache[type] : null;
            mainMaterial.needsUpdate = true;
        }

        function applyTextureSettings(texture) {
            if(!texture) return;
            const tX = parseFloat(document.getElementById('mat-tiling-x').value);
            const tY = parseFloat(document.getElementById('mat-tiling-y').value);
            const rot = parseFloat(document.getElementById('mat-rot-tex').value);
            
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(tX, tY);
            texture.center.set(0.5, 0.5);
            texture.rotation = rot * (Math.PI / 180);
            texture.offset.copy(textureOffset);
        }

        function updateAllTextures() {
            mapTypes.forEach(t => { if(textureCache[t.id]) applyTextureSettings(textureCache[t.id]); });
            mainMaterial.needsUpdate = true;
        }

        // --- Setup & Utilities ---
        function setupEventListeners() {
            bindInputPair('light-intensity', 'num-light-intensity', (v) => dirLight.intensity = v);
            bindInputPair('light-soft', 'num-light-soft', (v) => dirLight.shadow.radius = v);
            
            const updateLightPos = () => {
                dirLight.position.set(parseFloat(document.getElementById('light-pos-x').value), 20, parseFloat(document.getElementById('light-pos-z').value));
            };
            bindInputPair('light-pos-x', 'num-light-pos-x', updateLightPos);
            bindInputPair('light-pos-z', 'num-light-pos-z', updateLightPos);

            bindInputPair('mat-metal', 'num-mat-metal', (v) => { rawMetalness = v; updateMaterialResponse(); });
            bindInputPair('mat-rough', 'num-mat-rough', (v) => { rawRoughness = v; updateMaterialResponse(); });
            bindInputPair('mat-wetness', 'num-mat-wetness', updateMaterialResponse);
            
            bindInputPair('mat-tiling-x', 'num-mat-tiling-x', updateAllTextures);
            bindInputPair('mat-tiling-y', 'num-mat-tiling-y', updateAllTextures);
            bindInputPair('mat-rot-tex', 'num-mat-rot-tex', updateAllTextures);
            bindInputPair('mat-disp', 'num-mat-disp', (v) => mainMaterial.displacementScale = v);
            bindInputPair('mat-norm', 'num-mat-norm', (v) => { mainMaterial.normalScale.set(v, v); updateMaterialResponse(); });
        }

        function bindInputPair(rangeId, numId, callback) {
            const range = document.getElementById(rangeId);
            const num = document.getElementById(numId);
            range.addEventListener('input', () => { num.value = range.value; callback(parseFloat(range.value)); });
            num.addEventListener('input', () => { range.value = num.value; callback(parseFloat(num.value)); });
        }
        
        function syncInputs(id, val) {
            document.getElementById(id).value = val;
            document.getElementById('num-' + id).value = val;
        }

        function setupDragAndDrop() {
            const overlay = document.getElementById('drop-overlay');
            window.addEventListener('dragenter', (e) => {
                if (!e.target.closest('.texture-slot') && e.dataTransfer.types.includes('Files')) overlay.classList.add('active');
            });
            window.addEventListener('dragleave', (e) => { if (e.target.id === 'drop-overlay') overlay.classList.remove('active'); });
            window.addEventListener('dragover', (e) => e.preventDefault());
            window.addEventListener('drop', (e) => {
                e.preventDefault(); overlay.classList.remove('active');
                if (!e.target.closest('.texture-slot') && e.dataTransfer.files.length) handleSmartDrop(e.dataTransfer.files);
            });
        }

        function handleSmartDrop(files) {
            for (let i = 0; i < files.length; i++) {
                const f = files[i];
                const n = f.name.toLowerCase();
                if (n.match(/color|albedo|diffuse|base/)) loadTextureFromFile(f, 'map');
                else if (n.match(/normal|nrm/)) loadTextureFromFile(f, 'normalMap');
                else if (n.match(/rough|rgh/)) loadTextureFromFile(f, 'roughnessMap');
                else if (n.match(/metal|met/)) loadTextureFromFile(f, 'metalnessMap');
                else if (n.match(/disp|height/)) loadTextureFromFile(f, 'displacementMap');
                else if (n.match(/ao|ambient/)) loadTextureFromFile(f, 'aoMap');
                else if (files.length === 1) loadTextureFromFile(f, 'map');
            }
        }

        window.toggleEnvMap = function(checked) {
            scene.environment = checked ? pmremGenerator.fromScene(new THREE.RoomEnvironment(), 0.04).texture : null;
        }

        window.resetMaterial = function() {
            textureCache = {}; mainMaterial.map = null; mainMaterial.normalMap = null; mainMaterial.roughnessMap = null; mainMaterial.metalnessMap = null; mainMaterial.aoMap = null; mainMaterial.displacementMap = null;
            document.querySelectorAll('.texture-slot').forEach(el => el.classList.remove('loaded'));
            document.querySelectorAll('.file-name-display').forEach(el => el.style.display = 'none');
            document.querySelectorAll('input[type=file]').forEach(el => el.value = '');
            
            rawRoughness = 0.5; rawMetalness = 0.5;
            syncInputs('mat-metal', 0.5); syncInputs('mat-rough', 0.5); syncInputs('mat-wetness', 0);
            syncInputs('mat-disp', 0); syncInputs('mat-tiling-x', 1.0); syncInputs('mat-tiling-y', 1.0); syncInputs('mat-rot-tex', 0);
            updateMaterialResponse(); mainMaterial.needsUpdate = true;
        }

        function onWindowResize() {
            camera.aspect = (window.innerWidth - 320) / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth - 320, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>